#!/bin/bash
set -e

echo "üîç Running Shopware Extension Verifier..."

EXTENSION_DIR=$(pwd)

# Run the same image and flags as manual command
docker run --rm -v "$EXTENSION_DIR":/ext ghcr.io/shopware/shopware-cli \
    extension validate --full --check-against highest /ext
SW_EXIT_CODE=$?
echo "Shopware Extension Verifier Exit Code: $SW_EXIT_CODE"

echo "üîç Running PHP_CodeSniffer (PHPCS)..."
sh ./pre-commit-checks/phpcs-check.sh
PHPCS_EXIT_CODE=$?
echo "PHPCS Exit Code: $PHPCS_EXIT_CODE"

if [ $SW_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Shopware Extension Verifier failed. Commit aborted."
    exit 1
fi

if [ $PHPCS_EXIT_CODE -ne 0 ]; then
    echo "‚ùå PHPCS check failed. Commit aborted."
    exit 1
fi

echo "‚úÖ All checks passed. Proceeding with commit."
exit 0
